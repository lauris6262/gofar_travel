---------PUNTO 3----------


CREATE OR REPLACE VIEW INFO_FACTURA AS

SELECT  P.NUM_PACIENTE,P.NOMBRE_PACIENTE,P.DIRECCION_PACIENTE,F.FECHA_FACTURA,SUM(DF.COSTO)AS TOTAL 

FROM FACTURA F

INNER JOIN PACIENTE P 
ON F.NUM_PACIENTE = P.NUM_PACIENTE

INNER JOIN DETALLE_FACTURA DF ON F.ID_FACTURA = DF.ID_FACTURA

INNER JOIN PRODUCTO PR 
ON DF.ID_PRODUCTO = PR.ID_PRODUCTO

INNER JOIN CENTRO_COSTOS CC 
ON PR.ID_CENTRO_COSTOS = CC.ID_CENTRO_COSTOS 

WHERE DF.COSTO= (
SELECT MAX(SUM(DF.COSTO))
FROM DETALLE_FACTURA DF 
INNER JOIN PRODUCTO P 
ON DF.ID_PRODUCTO = P.ID_PRODUCTO 

INNER JOIN CENTRO_COSTOS CC 
ON P.ID_CENTRO_COSTOS = CC.ID_CENTRO_COSTOS

WHERE CC.NOMBRE_CENTRO_COSTOS='HABITACION Y COMIDA'
GROUP BY DF.COSTO)
 AND CC.NOMBRE_CENTRO_COSTOS='HABITACION Y COMIDA' 

GROUP BY P.NUM_PACIENTE,P.NOMBRE_PACIENTE,P.DIRECCION_PACIENTE,F.FECHA_FACTURA;



--------------PUNTO 4--------------



-----PRIMERA FUNCIÓN

CREATE OR REPLACE FUNCTION CANTIDAD_ARTICULOS_FACTURA (CENTRO_COSTOS INTEGER,FACTURA INTEGER) 
RETURN INTEGER IS 
RESULTADO INTEGER;

BEGIN

SELECT COUNT(PR.ID_PRODUCTO) INTO RESULTADO

FROM FACTURA F 
INNER JOIN DETALLE_FACTURA DF 
ON F.ID_FACTURA = DF.ID_FACTURA 

INNER JOIN PRODUCTO PR 
ON DF.ID_PRODUCTO = PR.ID_PRODUCTO

INNER JOIN CENTRO_COSTOS CC 
ON PR.ID_CENTRO_COSTOS = CC.ID_CENTRO_COSTOS

WHERE F.ID_FACTURA = FACTURA AND CC.ID_CENTRO_COSTOS = CENTRO_COSTOS;

RETURN RESULTADO;

END;



-----PRIMERA FUNCIÓN

CREATE OR REPLACE FUNCTION SALDO_ARTICULOS_FACTURA (CENTRO_COSTOS INTEGER,FACTURA INTEGER)
RETURN INTEGER IS 
RESULTADO INTEGER;

BEGIN
 
SELECT SUM(PR.PRECIO) INTO RESULTADO 
FROM FACTURA F 

INNER JOIN DETALLE_FACTURA DF 
ON F.ID_FACTURA = DF.ID_FACTURA 

INNER JOIN PRODUCTO PR 
ON DF.ID_PRODUCTO = PR.ID_PRODUCTO

INNER JOIN CENTRO_COSTOS CC 
ON PR.ID_CENTRO_COSTOS = CC.ID_CENTRO_COSTOS

WHERE F.ID_FACTURA = FACTURA AND CC.ID_CENTRO_COSTOS = CENTRO_COSTOS;

RETURN RESULTADO;

END;