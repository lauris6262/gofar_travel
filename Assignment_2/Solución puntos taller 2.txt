
---------PUNTO 3----------

CREATE OR REPLACE VIEW INFO_FACTURA AS
SELECT  P.NUM_PACIENTE,P.NOMBRE_PACIENTE,P.DIRECCION_PACIENTE,F.FECHA_FACTURA,SUM(DF.COSTO)AS TOTAL,
(SELECT SUM(DF.COSTO) FROM  DETALLE_FACTURA DF
INNER JOIN PRODUCTO PR
ON DF.ID_PRODUCTO = PR.ID_PRODUCTO
INNER JOIN CENTRO_COSTOS CC
ON PR.ID_CENTRO_COSTOS = CC.ID_CENTRO_COSTOS
WHERE CC.NOMBRE_CENTRO_COSTOS = 'HABITACION Y COMIDA') AS TOTAL_HABITACIONYCOMIDA
FROM FACTURA F
INNER JOIN PACIENTE P
ON F.NUM_PACIENTE = P.NUM_PACIENTE
INNER JOIN DETALLE_FACTURA DF
ON F.ID_FACTURA = DF.ID_FACTURA
INNER JOIN PRODUCTO PR
ON DF.ID_PRODUCTO = PR.ID_PRODUCTO
INNER JOIN CENTRO_COSTOS CC
ON PR.ID_CENTRO_COSTOS = CC.ID_CENTRO_COSTOS
WHERE DF.COSTO= (SELECT MAX(SUM(DF.COSTO))
FROM DETALLE_FACTURA DF 
INNER JOIN PRODUCTO P 
ON DF.ID_PRODUCTO = P.ID_PRODUCTO 
INNER JOIN CENTRO_COSTOS CC 
ON P.ID_CENTRO_COSTOS = CC.ID_CENTRO_COSTOS
WHERE CC.NOMBRE_CENTRO_COSTOS='HABITACION Y COMIDA'
GROUP BY DF.COSTO) AND CC.NOMBRE_CENTRO_COSTOS='HABITACION Y COMIDA' 
GROUP BY P.NUM_PACIENTE,P.NOMBRE_PACIENTE,P.DIRECCION_PACIENTE,F.FECHA_FACTURA;



--------------PUNTO 4--------------



-----PRIMERA FUNCIÓN

CREATE OR REPLACE FUNCTION CANTIDAD_ARTICULOS_FACTURA (CENTRO_COSTOS INTEGER,FACTURA INTEGER) 
RETURN INTEGER IS 
RESULTADO INTEGER;

BEGIN

SELECT COUNT(PR.ID_PRODUCTO) INTO RESULTADO

FROM FACTURA F 
INNER JOIN DETALLE_FACTURA DF 
ON F.ID_FACTURA = DF.ID_FACTURA 

INNER JOIN PRODUCTO PR 
ON DF.ID_PRODUCTO = PR.ID_PRODUCTO

INNER JOIN CENTRO_COSTOS CC 
ON PR.ID_CENTRO_COSTOS = CC.ID_CENTRO_COSTOS

WHERE F.ID_FACTURA = FACTURA AND CC.ID_CENTRO_COSTOS = CENTRO_COSTOS;

RETURN RESULTADO;

END;



-----SEGUNDA FUNCIÓN

CREATE OR REPLACE FUNCTION SALDO_ARTICULOS_FACTURA (CENTRO_COSTOS INTEGER,FACTURA INTEGER)
RETURN INTEGER IS 
RESULTADO INTEGER;

BEGIN
 
SELECT SUM(PR.PRECIO) INTO RESULTADO 
FROM FACTURA F 

INNER JOIN DETALLE_FACTURA DF 
ON F.ID_FACTURA = DF.ID_FACTURA 

INNER JOIN PRODUCTO PR 
ON DF.ID_PRODUCTO = PR.ID_PRODUCTO

INNER JOIN CENTRO_COSTOS CC 
ON PR.ID_CENTRO_COSTOS = CC.ID_CENTRO_COSTOS

WHERE F.ID_FACTURA = FACTURA AND CC.ID_CENTRO_COSTOS = CENTRO_COSTOS;

RETURN RESULTADO;

END;


-----------------PUNTO 5----------------------

CREATE OR REPLACE VIEW FACTURAPACIENTE AS 
SELECT  P.NUM_PACIENTE
,P.NOMBRE_PACIENTE
,P.DIRECCION_PACIENTE
,F.FECHA_FACTURA
,F.FECHA_ADMISION
,F.FECHA_ALTA
,CANTIDAD_ARTICULOS_FACTURA(3,54) AS ARTICULOS_HABITACIONYCOMIDA 
,SALDO_ARTICULOS_FACTURA(3,54) AS TOTAL_HABITACIONYCOMIDA
,CANTIDAD_ARTICULOS_FACTURA(2,4) AS ARTICULOS_LABORATORIO
,SALDO_ARTICULOS_FACTURA(2,4)AS TOTAL_LABORATORIO 
,CANTIDAD_ARTICULOS_FACTURA(4,1)AS ARTICULOS_RADIOLOGIA 
,SALDO_ARTICULOS_FACTURA(4,1) AS TOTAL_RADIOLOGIA
FROM FACTURA F 
INNER JOIN PACIENTE P ON F.NUM_PACIENTE = P.NUM_PACIENTE
INNER JOIN DETALLE_FACTURA DF
ON F.ID_FACTURA = DF.ID_FACTURA
INNER JOIN PRODUCTO PR
ON DF.ID_PRODUCTO = PR.ID_PRODUCTO
INNER JOIN CENTRO_COSTOS CC 
ON PR.ID_CENTRO_COSTOS = CC.ID_CENTRO_COSTOS;

----------------------------PUNTO 6--------------------------

EXPLAIN PLAN
SET statement_id = 'EX_FACTURAPACIENTE' FOR
SELECT  P.NUM_PACIENTE
,P.NOMBRE_PACIENTE
,P.DIRECCION_PACIENTE
,F.FECHA_FACTURA
,F.FECHA_ADMISION
,F.FECHA_ALTA
,CANTIDAD_ARTICULOS_FACTURA(3,54) AS ARTICULOS_HABITACIONYCOMIDA 
,SALDO_ARTICULOS_FACTURA(3,54) AS TOTAL_HABITACIONYCOMIDA
,CANTIDAD_ARTICULOS_FACTURA(2,4) AS ARTICULOS_LABORATORIO
,SALDO_ARTICULOS_FACTURA(2,4)AS TOTAL_LABORATORIO 
,CANTIDAD_ARTICULOS_FACTURA(4,1)AS ARTICULOS_RADIOLOGIA 
,SALDO_ARTICULOS_FACTURA(4,1) AS TOTAL_RADIOLOGIA
FROM FACTURA F 
INNER JOIN PACIENTE P ON F.NUM_PACIENTE = P.NUM_PACIENTE
INNER JOIN DETALLE_FACTURA DF
ON F.ID_FACTURA = DF.ID_FACTURA
INNER JOIN PRODUCTO PR
ON DF.ID_PRODUCTO = PR.ID_PRODUCTO
INNER JOIN CENTRO_COSTOS CC 
ON PR.ID_CENTRO_COSTOS = CC.ID_CENTRO_COSTOS;

SELECT * FROM TABLE(DBMS_XPLAN.DISPLAY('PLAN_TABLE', 'EX_FACTURAPACIENTE','TYPICAL'));


---------------PUNTO 7-----------------------------
ALTER TABLE PRODUCTO
ADD Unidades_disponibles number default 10 not null;

SELECT * FROM PRODUCTO;

----------------PUNTO 8-----------------------------

CREATE OR REPLACE TRIGGER ACTUALIZAR_STOCK 
BEFORE INSERT ON DETALLE_FACTURA
FOR EACH ROW
BEGIN
UPDATE PRODUCTO 
SET unidades_disponibles = unidades_disponibles -1
WHERE ID_PRODUCTO = :NEW.ID_PRODUCTO;
END;

-------------PUNTO 9-----------------
CREATE OR REPLACE  PROCEDURE AUMENTAR_COSTO_ARTICULO
AS
BEGIN
UPDATE PRODUCTO 
SET PRECIO = PRECIO+(PRECIO *0.02)
WHERE ID_CENTRO_COSTOS = 3;

UPDATE PRODUCTO 
SET PRECIO = PRECIO+(PRECIO *0.035)
WHERE ID_CENTRO_COSTOS = 2;

UPDATE PRODUCTO 
SET PRECIO = PRECIO+(PRECIO *0.04)
WHERE ID_CENTRO_COSTOS = 4;
END;




